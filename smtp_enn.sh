#!/bin/bash

#----
#--	Autor: Oscar Espinosa
#--	Script que ennumera usuarios de SMTP de una lista dada
#----

#archivo temporal donde se redirige la salida de VRFY
tmp_file='.current_user_status'

#Funcion para imprimir ayuda del script al usuario
function printHelp(){
	echo ""
	echo "-------------------------AYUDA-----------------------"
	echo ""
	echo "El script recibe 2 parametros necesarios y uno"
	echo "opcional."
	echo ""
	echo "ejemplo"
	echo " ./smtp_enn.sh <IP-destino> <archivo-usuarios> [<opcion>]"
	echo ""
	echo "El tercer parametro es indistinto, se usa para indicar"
	echo "cual metodo usar para listar los usuarios. Si no se indica"
	echo "se utiliza VRFY, si se indica un tercer parametro, se usa RCPT"
	echo ""
}

#Funcion que revisa si el usuario dado como parametro esta
#disponible en SMTP con el comando VRFY
function isListed_VRFY(){
	#Se realiza el comando y el resultado se almacena 
	#en un archivo temporal
	echo "VRFY $2" | nc $1  25 -q 1 > $tmp_file

	#Buscamos el codigo que se devuelve cuando un usuario
	#existe
	cat $tmp_file | grep 252 >/dev/null
	if [ $? -eq 0 ];then
		echo "$2 es un usuario valido"
	fi
}

#funcion que revisa si un usuario dado como parametro
#esta disponible en SMTP con el comando RCTP
function isListed_RCPT() {
	echo "MAIL FROM: anyone
		RCPT TO: $2" | nc $1 25 -q 1 > $tmp_file

	#buscamos el error que se genera cuando no existe el
	#usuario, si no existe match, entonces el usuario existe
	cat $tmp_file | grep 550 >/dev/null
	if [ $? -eq 1 ];then
		echo "$2 es un usuario valido"
	fi
}

###---------
#Funcion principal de script
###---------
function begin(){

	#Se usa para diferenciar el comando a usar para listar los
	#usuarios
	func=0
	#El tercer parametro indica enumeracion con RCPT
	if [ $# -eq 3 ];then
		echo "Iniciando enumeracion con RCPT"
		echo ""
		func=1
	else
		#Solo dos parametros indican listado con VRFY
		if [ $# -eq 2 ];then
			echo "Iniciando enumeracion con VRFY"
			echo ""
			func=0
		else
			echo "Numero de parametros invalido"
			printHelp
			exit 1
		fi
	fi

	#Se hace ping al host para ver si es alcanzable
	ping $1 -c 1 -W 1 >/dev/null 2>/dev/null
	if [ $? -eq 1 ];then
		echo "El host no es alcanzable"
		printHelp
		exit 1
	fi

	#Se valida que el archivo dado en el segundo parametro
	#exista
	if [ -f $2 ];then
		#Se lee linea a linea el archivo
		while read -r user; do
			if [ $func -eq 0 ];then
				isListed_VRFY $1 $user
			else
				isListed_RCPT $1 $user
			fi
		done < "$2"

	else
		echo "El archivo dado no existe"
		printHelp
		exit 1
	fi
}

begin $1 $2 $3
#Borrado del archivo temporal
rm $tmp_file
